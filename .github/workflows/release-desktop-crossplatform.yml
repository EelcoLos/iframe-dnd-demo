name: Cross-Platform Desktop Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          include-prerelease: true

      - name: Publish Linux x64
        working-directory: DesktopHost.Avalonia
        run: dotnet publish -c Release --self-contained --runtime linux-x64 -o ../publish-linux-x64

      - name: Package release
        run: zip -r DragDropAvaloniaDemo-linux-x64.zip publish-linux-x64/

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: DragDropAvaloniaDemo-linux-x64
          path: DragDropAvaloniaDemo-linux-x64.zip

      - name: Create GitHub Release (versioned tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: DragDropAvaloniaDemo-linux-x64.zip
          generate_release_notes: false
          body: |
            ## Cross-Platform Desktop Release (Avalonia)

            Download and extract the zip for your platform, then run the `DragDropAvaloniaDemo` executable.

            ### Requirements
            - **Linux:** `libwebkit2gtk-4.0` (install via `sudo apt install libwebkit2gtk-4.0-dev` on Debian/Ubuntu)
            - **macOS:** No extra dependencies required

            ### Usage
            1. Extract the zip file to a folder of your choice
            2. Run `DragDropAvaloniaDemo` (Linux/macOS) or `DragDropAvaloniaDemo.exe` (Windows — use the Windows release instead)
            3. Choose a demo mode from the toolbar

      - name: Update rolling latest-build pre-release (main branch)
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest-build
          name: Latest Build (main)
          prerelease: true
          files: DragDropAvaloniaDemo-linux-x64.zip
          body: |
            ## Latest Cross-Platform Desktop Build (Avalonia)

            This pre-release is automatically updated on every push to `main`.
            For a stable versioned release, see the [Releases page](https://github.com/EelcoLos/iframe-dnd-demo/releases).

            Download and extract the zip for your platform, then run the `DragDropAvaloniaDemo` executable.

            ### Requirements
            - **Linux:** `libwebkit2gtk-4.0` (install via `sudo apt install libwebkit2gtk-4.0-dev` on Debian/Ubuntu)
            - **macOS:** No extra dependencies required

  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          include-prerelease: true

      - name: Publish macOS x64
        working-directory: DesktopHost.Avalonia
        run: dotnet publish -c Release --self-contained --runtime osx-x64 -o ../publish-osx-x64

      - name: Publish macOS arm64
        working-directory: DesktopHost.Avalonia
        run: dotnet publish -c Release --self-contained --runtime osx-arm64 -o ../publish-osx-arm64

      - name: Package releases
        run: |
          zip -r DragDropAvaloniaDemo-osx-x64.zip publish-osx-x64/
          zip -r DragDropAvaloniaDemo-osx-arm64.zip publish-osx-arm64/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DragDropAvaloniaDemo-osx
          path: |
            DragDropAvaloniaDemo-osx-x64.zip
            DragDropAvaloniaDemo-osx-arm64.zip

      - name: Create GitHub Release (versioned tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            DragDropAvaloniaDemo-osx-x64.zip
            DragDropAvaloniaDemo-osx-arm64.zip
          generate_release_notes: false
          body: |
            ## DragDropAvaloniaDemo for macOS

            This release contains self-contained builds of DragDropAvaloniaDemo for macOS:

            - `DragDropAvaloniaDemo-osx-x64.zip` — Intel (x64) macOS
            - `DragDropAvaloniaDemo-osx-arm64.zip` — Apple Silicon (arm64) macOS

            ### Requirements
            - macOS 12 (Monterey) or later is recommended.
            - Use the x64 build on Intel-based Macs.
            - Use the arm64 build on Apple Silicon-based Macs.

            ### Installation
            1. Download the ZIP file that matches your Mac's architecture.
            2. Extract the ZIP archive to a folder of your choice.
            3. Locate the `DragDropAvaloniaDemo` executable inside the extracted folder.

            ### Usage
            - Double-click the `DragDropAvaloniaDemo` application to run it.
            - On first launch, macOS Gatekeeper may block the app because it is not notarized.
              - If this happens, open **System Settings** → **Privacy & Security** and allow the app to run.
              - Then try launching the app again.

            For more details, refer to the project documentation or README in the repository.

      - name: Update rolling latest-build pre-release (main branch)
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest-build
          name: Latest Build (main)
          prerelease: true
          files: |
            DragDropAvaloniaDemo-osx-x64.zip
            DragDropAvaloniaDemo-osx-arm64.zip
