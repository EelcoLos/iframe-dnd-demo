<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Draggable Items</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
      min-height: 100vh;
    }

    h2 {
      color: #4f46e5;
      margin-bottom: 20px;
      font-size: 1.5em;
    }

    .draggable-items {
      display: flex;
      flex-direction: column;
      gap: 15px;
      min-height: 300px;
      padding: 20px;
      border: 3px dashed transparent;
      border-radius: 12px;
      transition: all 0.2s ease;
    }

    .draggable-items.hover {
      background: #ede9fe;
      border-color: #8b5cf6;
      border-style: solid;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .draggable {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 25px;
      border-radius: 12px;
      cursor: move;
      font-weight: 600;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      transition: all 0.2s ease;
      user-select: none;
      touch-action: none;
      position: relative;
    }

    .draggable:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }

    .draggable:active {
      transform: scale(0.98);
    }

    .draggable.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .emoji {
      margin-right: 10px;
      font-size: 1.2em;
    }

    .hint {
      text-align: center;
      color: #94a3b8;
      font-size: 0.9em;
      margin-top: 10px;
    }
    
    .drag-preview {
      position: fixed;
      pointer-events: none;
      background: #4f46e5;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
      font-weight: 600;
      font-size: 14px;
      z-index: 10000;
      opacity: 0.9;
      transform: translate(-50%, -50%);
      display: none;
    }
  </style>
</head>
<body>
  <h2>üì¶ Draggable Items</h2>
  <div class="draggable-items" id="draggable-container">
    <div class="draggable" data-id="1">
      <span class="emoji">üé®</span>Design Asset
    </div>
    <div class="draggable" data-id="2">
      <span class="emoji">üìù</span>Documentation
    </div>
    <div class="draggable" data-id="3">
      <span class="emoji">üíª</span>Code Module
    </div>
    <div class="draggable" data-id="4">
      <span class="emoji">üéØ</span>Task Item
    </div>
    <div class="draggable" data-id="5">
      <span class="emoji">üîß</span>Configuration
    </div>
  </div>
  <div class="hint">Drag items to the Drop Zones window ‚Üí</div>
  
  <div id="no-coordinator-warning" style="display: none; background: #fee; border: 2px solid #c33; border-radius: 8px; padding: 15px; margin-top: 20px; color: #a00;">
    <strong>‚ö†Ô∏è Warning:</strong> This window was not opened from the Coordinator!
    <br>
    <small>Cross-window drag & drop requires opening windows from <a href="parent-windows.html" target="_blank">parent-windows.html</a></small>
  </div>
  
  <div class="drag-preview" id="drag-preview"></div>

  <script type="module">
    import { HybridCommunicationManager } from './hybrid-communication.js';

    const windowId = 'frame-a';
    const broadcast = new HybridCommunicationManager({ windowId });
    broadcast.initializeAsChild();
    
    // Show warning if no coordinator
    if (!window.opener || window.opener.closed) {
      document.getElementById('no-coordinator-warning').style.display = 'block';
    }

    const container = document.getElementById('draggable-container');
    const dragPreview = document.getElementById('drag-preview');
    let draggedElement = null;
    let isDragging = false;
    let dragData = null;
    let dragStartPos = { x: 0, y: 0 };
    const DRAG_THRESHOLD = 5;

    // Set up draggable items
    function initializeDraggables() {
      const draggables = container.querySelectorAll('.draggable');
      
      draggables.forEach(element => {
        element.addEventListener('pointerdown', handlePointerDown);
      });
    }

    function handlePointerDown(e) {
      if (e.button !== 0) return; // Only left mouse button
      
      draggedElement = e.currentTarget;
      dragStartPos = { x: e.clientX, y: e.clientY };
      
      // Set up move and up listeners
      document.addEventListener('pointermove', handlePointerMove);
      document.addEventListener('pointerup', handlePointerUp);
      
      // Capture pointer for reliable tracking
      draggedElement.setPointerCapture(e.pointerId);
    }

    function handlePointerMove(e) {
      if (!draggedElement) return;
      
      const dx = e.clientX - dragStartPos.x;
      const dy = e.clientY - dragStartPos.y;
      const distance = Math.sqrt(dx * dx + dy * dy);
      
      // Start drag if moved beyond threshold
      if (!isDragging && distance > DRAG_THRESHOLD) {
        startDrag(e);
      }
      
      if (isDragging) {
        updateDragPreview(e.clientX, e.clientY);
        
        // Broadcast drag move
        broadcast.broadcast('dragMove', {
          ...dragData,
          clientX: e.clientX,
          clientY: e.clientY,
          screenX: e.screenX,
          screenY: e.screenY
        });
      }
    }

    function handlePointerUp(e) {
      if (isDragging) {
        endDrag(e);
      }
      
      // Clean up
      document.removeEventListener('pointermove', handlePointerMove);
      document.removeEventListener('pointerup', handlePointerUp);
      
      if (draggedElement) {
        draggedElement.releasePointerCapture(e.pointerId);
        draggedElement = null;
      }
    }

    function startDrag(e) {
      isDragging = true;
      
      draggedElement.classList.add('dragging');
      
      dragData = {
        text: draggedElement.textContent.trim(),
        id: draggedElement.dataset.id,
        source: windowId
      };
      
      // Show drag preview
      dragPreview.textContent = dragData.text;
      dragPreview.style.display = 'block';
      updateDragPreview(e.clientX, e.clientY);
      
      // Broadcast drag start
      broadcast.broadcast('dragStart', dragData);
    }

    function updateDragPreview(x, y) {
      dragPreview.style.left = x + 'px';
      dragPreview.style.top = y + 'px';
    }

    function endDrag(e) {
      // Broadcast drag end
      broadcast.broadcast('dragEnd', {
        ...dragData,
        clientX: e.clientX,
        clientY: e.clientY,
        screenX: e.screenX,
        screenY: e.screenY
      });
      
      // Clean up
      if (draggedElement) {
        draggedElement.classList.remove('dragging');
      }
      
      dragPreview.style.display = 'none';
      isDragging = false;
      dragData = null;
    }

    // Listen for messages to remove items
    broadcast.on('removeItem', (data) => {
      if (data.id) {
        const element = container.querySelector(`[data-id="${data.id}"]`);
        if (element) {
          element.style.animation = 'fadeOut 0.3s ease';
          setTimeout(() => element.remove(), 300);
        }
      }
    });

    // Listen for drop messages to receive items back
    broadcast.on('parentDrop', (data) => {
      if (!data.dragData || data.dragData.source === windowId) return;
      
      // Add the item to this container
      const newItem = document.createElement('div');
      newItem.className = 'draggable';
      newItem.dataset.id = data.dragData.id;
      newItem.innerHTML = data.dragData.text;
      
      container.appendChild(newItem);
      
      // Initialize draggable on new item
      newItem.addEventListener('pointerdown', handlePointerDown);
      
      // Animate in
      newItem.style.animation = 'fadeIn 0.3s ease';
    });

    // Initialize all draggables
    initializeDraggables();
  </script>
  
  <style>
    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: scale(1);
      }
      to {
        opacity: 0;
        transform: scale(0.9);
      }
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>
</body>
</html>
